apiVersion: batch/v1
kind: Job
metadata:
  name: rsync-lubelogger-fe
  namespace: lubelogger
spec:
  backoffLimit: 1
  template:
    spec:
      restartPolicy: OnFailure
      # 1) Pin to the node that hosts the local-path PV
      nodeSelector:
        kubernetes.io/hostname: hl1

      # 2) Tolerate the control-plane taint on hl1
      tolerations:
      - key: "node-role.kubernetes.io/control-plane"
        operator: "Exists"
        effect: "NoSchedule"

      containers:
      - name: rsync
        image: bitnami/rsync:latest   # rsync preinstalled; no apk
        command: ["/bin/bash","-lc"]
        args:
          - |
            set -euo pipefail
            echo "Listing source and destination sizes (may take a moment)..."
            du -sh /src || true; du -sh /dst || true
            echo "Starting rsync..."
            rsync -avh --info=progress2 --numeric-ids \
                  --delete --inplace \
                  /src/ /dst/
            echo "Done. Verifying counts..."
            src_cnt=$(find /src -type f | wc -l); dst_cnt=$(find /dst -type f | wc -l)
            echo "Files: src=$src_cnt dst=$dst_cnt"
        securityContext:
          runAsUser: 0
          runAsGroup: 0
        volumeMounts:
        - name: src
          mountPath: /src
        - name: dst
          mountPath: /dst
      volumes:
      - name: src
        persistentVolumeClaim:
          claimName: lubelogger-fe-pvc            # old local-path PVC (source)
      - name: dst
        persistentVolumeClaim:
          claimName: lubelogger-fe-longhorn       # new Longhorn PVC (target)

